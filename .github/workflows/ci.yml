---
name: CI

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

# Restrict permissions for security
permissions:
  contents: read
  pull-requests: write  # Needed to comment on PRs and manage labels

jobs:
  # Remove safe-to-test label on new commits to require re-approval
  reset-approval:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Remove safe-to-test label on new commits
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            if (labels.includes('safe-to-test')) {
              console.log('Removing safe-to-test label to require re-approval for new commits');
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  name: 'safe-to-test'
                });
              } catch (error) {
                // Label might not exist, ignore
                console.log('Label already removed or does not exist');
              }
            }

  # Check if PR author is a collaborator/member
  check-permissions:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: reset-approval  # Wait for label to be removed first
    permissions:
      contents: read
    outputs:
      is-member: ${{ steps.check.outputs.is-member }}
    steps:
      - name: Check if user is collaborator
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: context.payload.pull_request.user.login
              });
              const hasPermission = ['admin', 'write', 'maintain'].includes(permission.permission);
              console.log(`User ${context.payload.pull_request.user.login} has permission: ${permission.permission}`);
              core.setOutput('is-member', hasPermission);
            } catch (error) {
              console.log(`User ${context.payload.pull_request.user.login} is not a collaborator`);
              core.setOutput('is-member', false);
            }

  # Check for approval label on PR
  check-approval:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: check-permissions
    permissions:
      contents: read
    outputs:
      approved: ${{ steps.check-label.outputs.approved }}
    steps:
      - name: Check for safe-to-test label
        id: check-label
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            const isMember = '${{ needs.check-permissions.outputs.is-member }}' === 'true';
            const hasLabel = labels.includes('safe-to-test');
            const approved = isMember || hasLabel;
            console.log(`Is member: ${isMember}, Has safe-to-test label: ${hasLabel}, Approved: ${approved}`);
            core.setOutput('approved', approved);

  # Lint and syntax validation on push (no approval required)
  static-analysis-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Run Puppet syntax validation
        run: bundle exec rake syntax

      - name: Run Puppet lint
        run: bundle exec rake lint

      - name: Run RuboCop
        run: bundle exec rake rubocop

      - name: Run metadata lint
        run: bundle exec rake metadata_lint

  # Lint and syntax validation on PR (requires approval)
  static-analysis-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: github.event_name == 'pull_request' && needs.check-approval.outputs.approved == 'true'
    needs: check-approval
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Run Puppet syntax validation
        run: bundle exec rake syntax

      - name: Run Puppet lint
        run: bundle exec rake lint

      - name: Run RuboCop
        run: bundle exec rake rubocop

      - name: Run metadata lint
        run: bundle exec rake metadata_lint

  # Run RSpec unit tests
  unit-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.check-approval.outputs.approved == 'true')
    needs: [check-approval, static-analysis-push, static-analysis-pr]
    strategy:
      matrix:
        puppet: ['8']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Run unit tests
        run: bundle exec rake spec

  # Run acceptance tests
  acceptance-tests-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: github.event_name == 'push'
    needs: [unit-tests]
    strategy:
      fail-fast: false
      matrix:
        platform: ['debian', 'rocky']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run acceptance tests on ${{ matrix.platform }}
        run: DOCKER_IN_DOCKER=1 bundle exec rake acceptance:${{ matrix.platform }}
        timeout-minutes: 30

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-logs-${{ matrix.platform }}
          path: |
            log/
            junit/
          retention-days: 7

  acceptance-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: github.event_name == 'pull_request' && needs.check-approval.outputs.approved == 'true'
    needs: [check-approval, unit-tests]
    strategy:
      fail-fast: false
      matrix:
        platform: ['debian', 'rocky']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run acceptance tests on ${{ matrix.platform }}
        run: DOCKER_IN_DOCKER=1 bundle exec rake acceptance:${{ matrix.platform }}
        timeout-minutes: 30

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-logs-${{ matrix.platform }}
          path: |
            log/
            junit/
          retention-days: 7

  # Comment on PR if approval needed
  approval-required:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    if: |
      github.event_name == 'pull_request' &&
      needs.check-approval.outputs.approved == 'false'
    needs: check-approval
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const body = `ðŸ‘‹ Thanks for your contribution!
            
            This PR requires approval from a project maintainer before tests can run.
            
            **For maintainers:** Add the \`safe-to-test\` label to this PR to run the test suite.`;
            
            // Check if we've already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('safe-to-test')
            );
            
            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body
              });
            }
